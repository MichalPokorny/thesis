# -pedantic-errors
CFLAGS=-std=c11 -W -Wall -Werror -O3 -rdynamic -D_GNU_SOURCE -I. -march=native
LIBS=-lm -lrt -lucw-6.4

SOURCES= \
	btree/*.c \
	cobt/*.c \
	dict/*.c \
	dict/test/*.c \
	htable/*.c \
	kforest/*.c \
	ksplay/*.c \
	log/*.c \
	math/*.c \
	rand/*.c \
	splay/*.c \
	util/*.c \
	veb_layout/*.c

.PHONY: asm test test_coverage clean

bin/test: test.c $(SOURCES)
	$(CC) -g $(CFLAGS) test.c $(SOURCES) $(LIBS) -o $@

bin/test_profile: test.c $(SOURCES)
	$(CC) -pg $(CFLAGS) test.c $(SOURCES) $(LIBS) -o $@

bin/test_coverage: test.c $(SOURCES)
	$(CC) --coverage -ftest-coverage $(CFLAGS) test.c $(SOURCES) $(LIBS) -o $@

# Generated by GCC, not very readable.
#asm: test.c $(SOURCES)
#	$(CC) $(CFLAGS) -S -fverbose-asm test.c $(SOURCES)

# Produces 1 C-annotated assembly file
asm: bin/test
	objdump -S bin/test > asm.dump

# experiments/btree-dot
bin/experiments/btree-dot: $(SOURCES) experiments/btree-dot/btree-dot.c
	$(CC) -g $(CFLAGS) $(SOURCES) experiments/btree-dot/btree-dot.c $(LIBS) -o $@

# experiments/cloud
CLOUD_SOURCES=$(SOURCES) measurement/measurement.c measurement/stopwatch.c experiments/cloud/cloud.c experiments/cloud/flags.c
CLOUD_CFLAGS=$(CFLAGS) $(shell pkg-config --cflags jansson)
CLOUD_LIBS=$(LIBS) $(shell pkg-config --libs jansson)
bin/experiments/cloud: $(CLOUD_SOURCES)
	$(CC) -g $(CLOUD_CFLAGS) -DNDEBUG $(CLOUD_SOURCES) $(CLOUD_LIBS) -o $@

# experiments/performance

# bin/experiments/performance depends on jansson
PERFORMANCE_CFLAGS=$(CFLAGS) $(shell pkg-config --cflags jansson)
PERFORMANCE_LIBS=$(LIBS) $(shell pkg-config --libs jansson)
PERFORMANCE_SOURCES=$(SOURCES) \
	experiments/performance/*.c \
	measurement/*.c

bin/experiments/performance: $(PERFORMANCE_SOURCES)
	$(CC) -g $(PERFORMANCE_CFLAGS) -DNDEBUG $(PERFORMANCE_SOURCES) $(PERFORMANCE_LIBS) -o $@

bin/experiments/performance_profile: $(PERFORMANCE_SOURCES)
	$(CC) -pg $(PERFORMANCE_CFLAGS) $(PERFORMANCE_SOURCES) $(PERFORMANCE_LIBS) -o $@

# experiments/vcr
VCR_CFLAGS=$(CFLAGS) $(shell pkg-config --cflags jansson)
VCR_LIBS=$(LIBS) $(shell pkg-config --libs jansson)
VCR_SOURCES=$(SOURCES) \
	experiments/vcr/*.c \
	measurement/*.c

bin/experiments/vcr: $(VCR_SOURCES)
	$(CC) -g $(VCR_CFLAGS) -DNDEBUG $(VCR_SOURCES) $(VCR_LIBS) -o $@

bin/experiments/vcr_profile: $(VCR_SOURCES)
	$(CC) -pg $(VCR_CFLAGS) $(VCR_SOURCES) $(VCR_LIBS) -o $@

# experiments/veb_performance
VEB_PERFORMANCE_SOURCES=$(SOURCES) measurement/measurement.c measurement/stopwatch.c experiments/veb_performance/veb_performance.c
bin/experiments/veb_performance: $(VEB_PERFORMANCE_SOURCES)
	$(CC) $(CFLAGS) $(VEB_PERFORMANCE_SOURCES) $(LIBS) -ljansson -o $@

# experiments/cuckoo-cube
CUCKOO_CUBE_SOURCES=$(SOURCES) experiments/cuckoo-cube/cuckoo-cube.c
bin/experiments/cuckoo-cube: $(CUCKOO_CUBE_SOURCES)
	$(CC) $(CFLAGS) $(CUCKOO_CUBE_SOURCES) $(LIBS) -o $@

# Continuous integration target
# TODO: Check that everything else builds, too.
test: bin/test bin/experiments/performance bin/experiments/vcr bin/experiments/btree-dot bin/experiments/cloud
	bin/test

test_coverage: bin/test_coverage
	bin/test_coverage
	lcov --capture --directory . --output-file coverage.info
	genhtml coverage.info --output-directory coverage-out
	find . -name '*.gcda' -o -name '*.gcno' | xargs rm
	rm coverage.info

clean:
	rm bin/test* bin/experiments/*
