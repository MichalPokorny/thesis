# -pedantic-errors
CFLAGS=-std=c11 -W -Wall -Werror -O3 -rdynamic -D_GNU_SOURCE -I.
LIBS=-lm -lrt

SOURCES= \
	btree/*.c \
	cobt/*.c \
	hashtable/private/*.c hashtable/test/*.c \
	dict/*.c \
	dict/test/*.c \
	log/*.c \
	math/*.c \
	observation/*.c observation/test/*.c \
	performance/*.c \
	rand/*.c rand/test/*.c \
	splay/*.c \
	stopwatch/*.c measurement/*.c \
	util/*.c \
	veb_layout/*.c

bin/test: test.c $(SOURCES)
	$(CC) -g $(CFLAGS) test.c $(SOURCES) -o $@ $(LIBS)

bin/test_profile: test.c $(SOURCES)
	$(CC) -pg $(CFLAGS) test.c $(SOURCES) -o $@ $(LIBS)

bin/test_coverage: test.c $(SOURCES)
	$(CC) -fprofile-arcs -ftest-coverage $(CFLAGS) test.c $(SOURCES) -o $@ $(LIBS)

# Generated by GCC, not very readable.
#asm: test.c $(SOURCES)
#	$(CC) $(CFLAGS) -S -fverbose-asm test.c $(SOURCES)

# Produces 1 C-annotated assembly file
asm: bin/test
	objdump -S bin/test > asm.dump

bin/performance: performance.c $(SOURCES)
	$(CC) $(CFLAGS) performance.c $(SOURCES) -o $@ $(LIBS)

PERFORMANCE_SOURCES=$(SOURCES) experiments/performance/performance.c experiments/performance/flags.c

bin/experiments/performance: $(PERFORMANCE_SOURCES)
	$(CC) -g $(CFLAGS) $(PERFORMANCE_SOURCES) -o $@ $(LIBS)

bin/experiments/performance_profile: $(PERFORMANCE_SOURCES)
	$(CC) -pg $(CFLAGS) $(PERFORMANCE_SOURCES) -o $@ $(LIBS)

bin/experiments/veb_performance: experiments/veb_performance/veb_performance.c $(SOURCES)
	$(CC) $(CFLAGS) experiments/veb_performance/veb_performance.c $(SOURCES) -o $@ $(LIBS)

# Continuous integration target
test: bin/test
	bin/test
