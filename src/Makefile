# -pedantic-errors
CFLAGS=-std=c11 -W -Wall -Werror -O3 -rdynamic -D_GNU_SOURCE -I. -march=native
LIBS=-lm -lrt

SOURCES= \
	btree/*.c \
	cobt/*.c \
	dict/*.c \
	dict/test/*.c \
	htable/*.c htable/test/*.c \
	kforest/*.c \
	ksplay/*.c \
	log/*.c \
	math/*.c \
	observation/*.c \
	rand/*.c \
	splay/*.c \
	util/*.c \
	veb_layout/*.c

bin/test: test.c $(SOURCES)
	$(CC) -g $(CFLAGS) test.c $(SOURCES) $(LIBS) -o $@

bin/test_profile: test.c $(SOURCES)
	$(CC) -pg $(CFLAGS) test.c $(SOURCES) $(LIBS) -o $@

bin/test_coverage: test.c $(SOURCES)
	$(CC) --coverage -ftest-coverage $(CFLAGS) test.c $(SOURCES) $(LIBS) -o $@

# Generated by GCC, not very readable.
#asm: test.c $(SOURCES)
#	$(CC) $(CFLAGS) -S -fverbose-asm test.c $(SOURCES)

# Produces 1 C-annotated assembly file
asm: bin/test
	objdump -S bin/test > asm.dump

# bin/experiments/performance depends on jansson
PERFORMANCE_CFLAGS=$(CFLAGS) $(shell pkg-config --cflags jansson)
PERFORMANCE_LIBS=$(LIBS) $(shell pkg-config --libs jansson)
PERFORMANCE_SOURCES=$(SOURCES) \
	experiments/performance/*.c \
	measurement/*.c

bin/experiments/performance: $(PERFORMANCE_SOURCES)
	$(CC) -g $(PERFORMANCE_CFLAGS) -DNDEBUG $(PERFORMANCE_SOURCES) $(PERFORMANCE_LIBS) -o $@

bin/experiments/performance_profile: $(PERFORMANCE_SOURCES)
	$(CC) -pg $(PERFORMANCE_CFLAGS) $(PERFORMANCE_SOURCES) $(PERFORMANCE_LIBS) -o $@

VEB_PERFORMANCE_SOURCES=$(SOURCES) measurement/measurement.c measurement/stopwatch.c experiments/veb_performance/veb_performance.c
bin/experiments/veb_performance: $(VEB_PERFORMANCE_SOURCES)
	$(CC) $(CFLAGS) $(VEB_PERFORMANCE_SOURCES) $(LIBS) -ljansson -o $@

# Continuous integration target
test: bin/test
	bin/test

test_coverage: bin/test_coverage
	bin/test_coverage
	lcov --capture --directory . --output-file coverage.info
	genhtml coverage.info --output-directory coverage-out
	find . -name '*.gcda' -o -name '*.gcno' | xargs rm
	rm coverage.info

clean:
	rm bin/test* bin/experiments/*
