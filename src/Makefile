# -pedantic-errors
CFLAGS=-std=c11 -W -Wall -Werror -O3 -rdynamic -D_GNU_SOURCE -I. $(shell pkg-config --cflags jansson)
LIBS=-lm -lrt $(shell pkg-config --libs jansson)

SOURCES= \
	btree/*.c \
	cobt/*.c \
	htable/*.c htable/private/*.c htable/test/*.c \
	dict/*.c \
	dict/test/*.c \
	log/*.c \
	math/*.c \
	observation/*.c \
	performance/*.c \
	rand/*.c \
	splay/*.c \
	measurement/*.c \
	util/*.c \
	veb_layout/*.c

bin/test: test.c $(SOURCES)
	$(CC) -g $(CFLAGS) $(LIBS) test.c $(SOURCES) -o $@

bin/test_profile: test.c $(SOURCES)
	$(CC) -pg $(CFLAGS) $(LIBS) test.c $(SOURCES) -o $@

bin/test_coverage: test.c $(SOURCES)
	$(CC) --coverage -ftest-coverage $(CFLAGS) $(LIBS) test.c $(SOURCES) -o $@

# Generated by GCC, not very readable.
#asm: test.c $(SOURCES)
#	$(CC) $(CFLAGS) -S -fverbose-asm test.c $(SOURCES)

# Produces 1 C-annotated assembly file
asm: bin/test
	objdump -S bin/test > asm.dump

bin/performance: performance.c $(SOURCES)
	$(CC) $(CFLAGS) $(LIBS) performance.c $(SOURCES) -o $@

PERFORMANCE_SOURCES=$(SOURCES) experiments/performance/performance.c experiments/performance/flags.c

bin/experiments/performance: $(PERFORMANCE_SOURCES)
	$(CC) -g $(CFLAGS) $(LIBS) $(PERFORMANCE_SOURCES) -o $@

bin/experiments/performance_profile: $(PERFORMANCE_SOURCES)
	$(CC) -pg $(CFLAGS) $(LIBS) $(PERFORMANCE_SOURCES) -o $@

bin/experiments/veb_performance: experiments/veb_performance/veb_performance.c $(SOURCES)
	$(CC) $(CFLAGS) $(LIBS) experiments/veb_performance/veb_performance.c $(SOURCES) -o $@

# Continuous integration target
test: bin/test
	bin/test

test_coverage: bin/test_coverage
	bin/test_coverage
	lcov --capture --directory . --output-file coverage.info
	genhtml coverage.info --output-directory coverage-out
	find . -name '*.gcda' -o -name '*.gcno' | xargs rm
	rm coverage.info
